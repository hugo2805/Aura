# GitHub Actions workflow â€” package Aura with Squirrel and a custom WPF installer
# Trigger : lorsquâ€™une Release GitHub est *publiÃ©e* (tag vX.Y.Z)

name: Package & Release (Windows)

permissions:
  contents: write

on:
  release:
    types: [published]

# ---------------------------------------------------------------------------
# Secrets requis
#   BUILD_BASE_URL â€” URL racine oÃ¹ se trouvent les ZIP (ex : https://build.sealion.fr)
#   GITHUB_TOKEN   â€” fourni automatiquement par GitHub
# ---------------------------------------------------------------------------

env:
  ZIP_NAME_TEMPLATE: Aura.zip   # nom du build Unity compressÃ©

jobs:
  windows:
    runs-on: windows-latest

    steps:
      # 1 â€“ Checkout du dÃ©pÃ´t
      - name: Checkout
        uses: actions/checkout@v4

      # 2 â€“ RÃ©cupÃ¨re la version depuis le tag (v1.2.3 â†’ 1.2.3)
      - name: Parse version
        id: vars
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION=${TAG#v}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # 3 â€“ TÃ©lÃ©charge le ZIP du player Unity
      - name: Download Unity build ZIP
        shell: pwsh
        run: |
          $base = "https://build.sealion.fr"
          $ver  = '${{ steps.vars.outputs.version }}'
          $zip  = '${{ env.ZIP_NAME_TEMPLATE }}'
          $url  = "$base/$ver/$zip"
          Write-Host "Downloading $url â€¦"
          Invoke-WebRequest -Uri $url -OutFile unity.zip -UseBasicParsing

      # 4 â€“ DÃ©compresse le ZIP Unity
      - name: Extract Unity ZIP
        run: 7z x unity.zip -obuild/UnityPlayer

      # 5 â€“ TÃ©lÃ©charge le ZIP prÃ©-compilÃ© dâ€™AuraInstaller (WPF) â€“ *nâ€™est PAS packagÃ© dans le .nupkg*
      - name: Download AuraInstaller ZIP
        shell: pwsh
        run: |
          $base = "https://build.sealion.fr"
          $ver  = '${{ steps.vars.outputs.version }}'
          $url  = "$base/$ver/AuraInstaller.zip"
          Write-Host "Downloading $url â€¦"
          Invoke-WebRequest -Uri $url -OutFile installer.zip -UseBasicParsing

      # 6 â€“ DÃ©compresse AuraInstaller (on garde le binaire pour plus tard)
      - name: Extract AuraInstaller ZIP
        run: 7z x installer.zip -obuild/Installer

      # 7 â€“ PrÃ©pare le contenu du package (.nupkg)
      - name: Prepare package content
        shell: pwsh
        run: |
          # -----------------------------------------------------------------
          # 1) Player Unity complet   â†’ package/â€¦
          # -----------------------------------------------------------------
          New-Item -ItemType Directory -Force -Path package | Out-Null
          Copy-Item -Recurse build/UnityPlayer/* package/ -Force

      # 8 â€“ GÃ©nÃ¨re Aura.nuspec ligne par ligne (echo) â€“ Ã©vite les soucis YAML
      - name: Create Aura.nuspec
        shell: bash
        run: |
          VER="${{ steps.vars.outputs.version }}"
          echo '<?xml version="1.0"?>'                         >  Aura.nuspec
          echo '<package>'                                      >> Aura.nuspec
          echo '  <metadata>'                                   >> Aura.nuspec
          echo '    <id>Aura</id>'                              >> Aura.nuspec
          echo "    <version>${VER}</version>"                >> Aura.nuspec
          echo '    <authors>Sealion</authors>'                 >> Aura.nuspec
          echo '    <description>AURA Unity app (player only) packagÃ©e par Squirrel.</description>' >> Aura.nuspec
          echo '  </metadata>'                                  >> Aura.nuspec
          echo '  <files>'                                      >> Aura.nuspec
          echo '    <file src="package/**" target="lib/net45" />' >> Aura.nuspec
          echo '    <file src="README.md" target="" />'     >> Aura.nuspec
          echo '  </files>'                                     >> Aura.nuspec
          echo '</package>'                                     >> Aura.nuspec

      # 8b â€“ README minimal pour NuGet
      - name: Create README.md
        run: echo "AURA Unity app packaged (player only)." > README.md

      # 9 â€“ CrÃ©e le .nupkg (Unity inclus)
      - name: NuGet pack
        run: nuget pack Aura.nuspec -Version ${{ steps.vars.outputs.version }} -OutputDirectory . -NoDefaultExcludes

      # 10 â€“ Installe lâ€™outil CLI Squirrel
      - name: Install Squirrel CLI
        run: nuget install squirrel.windows -OutputDirectory tools -Verbosity quiet

      # 11 â€“ Releasify : gÃ©nÃ¨re update.exe (= bootstrapper Squirrel)
      - name: Squirrel releasify (Unity only)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $ver      = '${{ steps.vars.outputs.version }}'
          $squirrel = Get-ChildItem tools -Recurse -Filter Squirrel.exe | Select-Object -First 1

          Remove-Item -Recurse -Force Releases -ErrorAction Ignore
          New-Item -ItemType Directory -Path Releases | Out-Null

          # EXE principal du player Unity (crÃ©era les raccourcis)
          $mainExe = 'Protec.exe'

          # --- Diagnostic : liste les fichiers dispos avant releasify -----
          Write-Host 'ðŸ“‚ Listing working dir before releasify:'
          Get-ChildItem -Recurse -File | ForEach-Object { Write-Host $_.FullName }
          # ----------------------------------------------------------------

          $args = @(
            '--releasify', "Aura.$ver.nupkg",
            '--releaseDir', 'Releases',
            '--no-msi',
            '--exe', $mainExe,
            '--verbose'
          )

          Write-Host ">> Running: $($squirrel.FullName) $($args -join ' ')"
          & $squirrel.FullName @args
          if ($LASTEXITCODE -ne 0) { throw "Squirrel releasify failed ($LASTEXITCODE)" }

          # --------------------------------------------------------------
          # âž” Copie AuraInstaller.exe Ã  cÃ´tÃ© de update.exe (mÃªme dossier)
          #    ainsi le lanceur WPF pourra appeler update.exe au runtime.
          # --------------------------------------------------------------
          Copy-Item build/Installer/AuraInstaller.exe Releases/ -Force

      # 12 â€“ VÃ©rification rapide des artÃ©facts
      - name: VÃ©rification des fichiers Squirrel
        shell: pwsh
        run: |
          if (-not (Test-Path 'Releases/RELEASES'))          { throw 'RELEASES manquant' }
          if (-not (Test-Path 'Releases/update.exe'))        { throw 'update.exe manquant' }
          if (-not (Test-Path 'Releases/AuraInstaller.exe')) { throw 'AuraInstaller.exe manquant' }
          Write-Host 'âœ… ArtÃ©facts Squirrel OK'

      # 13 â€“ Debug : liste les EXE/NUPKG gÃ©nÃ©rÃ©s
      - name: ðŸ”Ž Debug build outputs
        shell: pwsh
        run: Get-ChildItem -Recurse | Where-Object { $_.Name -match '\\.(exe|nupkg)$' }

      # 14 â€“ Attache les artÃ©facts Ã  la Release GitHub
      - name: Attach artefacts to GitHub Release
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: false
          files: Releases/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
