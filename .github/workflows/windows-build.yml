# .github/workflows/build.yml
# ------------------------------------------------------------
# G√©n√®re l'installeur Windows pour **chaque tag** (push de vX.Y.Z).
# 1. Compile l'Updater WPF (.NET¬†8)
# 2. T√©l√©charge le build Unity zipp√© depuis le serveur perso
# 3. Fusionne Updater + jeu + version.txt dans BuildReady/
# 4. Met √† jour le **version.txt** sur le serveur distant
# 5. Ex√©cute Inno¬†Setup pour cr√©er `Aura_Setup.exe`
# 6. Publie l'ex√©cutable¬†:
#    ‚Ä¢ artefact de workflow (debug)
#    ‚Ä¢ asset de la Release GitHub correspondante (prod)
# ------------------------------------------------------------

name: Build Windows Installer

on:
  push:
    tags:
      - "*"   # tout tag d√©clenche le build

# IMPORTANT pour pouvoir attacher l'ex√©cutable √† la Release
permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    env:
      UNITY_ZIP_URL: "https://build.sealion.fr/updates/Aura.zip"  # URL du zip Unity
      BUILD_DIR: BuildReady                                       # dossier temporaire local

    steps:
      # --------------------------------------------------
      # 0) Checkout
      # --------------------------------------------------
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v3

      # --------------------------------------------------
      # 1) .NET¬†SDK
      # --------------------------------------------------
      - name: ‚öôÔ∏è Setup .NET¬†8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x"

      # --------------------------------------------------
      # 2) Build Updater WPF
      # --------------------------------------------------
      - name: üß± Restore & publish Updater
        run: |
          dotnet restore Updater/AuraInstaller.sln
          dotnet publish Updater/AuraInstaller.csproj -c Release -o "${{ env.BUILD_DIR }}\\Updater"

      # --------------------------------------------------
      # 3) T√©l√©charge le jeu Unity (zip)
      # --------------------------------------------------
      - name: üì• Download Unity build
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "${{ env.UNITY_ZIP_URL }}" -OutFile unity.zip
          Expand-Archive -Path unity.zip -DestinationPath "${{ env.BUILD_DIR }}\\Game" -Force

      # --------------------------------------------------
      # 4) G√©n√®re version.txt √† partir du tag
      # --------------------------------------------------
      - name: üè∑Ô∏è Generate version.txt
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace "^refs/tags/", "" -replace "^v", ""
          Set-Content -Path "${{ env.BUILD_DIR }}\\version.txt" -Value $version
          echo "AppVersion=$version" | Out-File -FilePath $Env:GITHUB_ENV -Append

      # --------------------------------------------------
      # 4-bis) Pousse version.txt sur le serveur de mises √† jour
      #        (n√©cessite secrets REMOTE_HOST / REMOTE_USER / REMOTE_SSH_KEY)
      # --------------------------------------------------
      - name: üåê Upload version.txt to remote storage
        if: secrets.REMOTE_HOST != ''
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_SSH_KEY }}
          port: ${{ '22' }}
          source: "${{ env.BUILD_DIR }}/version.txt"
          target: ${{ secrets.REMOTE_DIR }}

      # --------------------------------------------------
      # 5) Installe Inno¬†Setup¬†6 (si pas d√©j√† pr√©sent)
      # --------------------------------------------------
      - name: üß∞ Install Inno Setup 6
        run: choco install innosetup --no-progress

      # --------------------------------------------------
      # 6) Compile l'installeur via ISCC
      # --------------------------------------------------
      - name: üõ†Ô∏è Run ISCC
        shell: pwsh
        run: |
          & "C:\\Program Files (x86)\\Inno Setup 6\\ISCC.exe" `
            /DMyBuildDir="${{ github.workspace }}\\${{ env.BUILD_DIR }}" `
            /DAppVersion=${{ env.AppVersion }} `
            Installer\setup.iss

      # --------------------------------------------------
      # 7) Publie l'EXE
      # --------------------------------------------------
      - name: ‚¨ÜÔ∏è Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: AuraInstaller
          path: Installer/Output/*.exe

      - name: üöÄ Publish asset to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Aura_Setup.exe
          tag_name: ${{ github.ref_name }}
          files: Installer/Output/Aura_Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
